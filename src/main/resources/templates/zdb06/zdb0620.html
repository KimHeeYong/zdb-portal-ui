<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" 
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/content_layout">
<th:block layout:fragment="page_head">
	<title>DB관리</title>
</th:block>
<th:block layout:fragment="page_css">
</th:block>
<th:block layout:fragment="page_js">
	<script type="text/javascript" src="/script/app/common/cloudzdb-validator.js"></script>
</th:block>
<th:block layout:fragment="content">
	<!-- Location -->
	<div class="locations-area">
		<div class="prj-list">
			<strong>Namespace : </strong>
			<button id="namespaces" class="Dropdownbutton namespace"></button>
			<ul class="dropmenu-list hide">
			</ul>
		</div>
	</div>
	<!-- Contents -->
	<div class="contents-box">
		<!-- Top Area -->
		<!-- button wrap-->
		<h3 class="form-title">DB정보</h3>
		<div id="tabDatabase">
			<div class="tabs-contents">
				<div style="width: 500px;">
					<div class="btn-wrap">
						<div class="btn-right">
							<button class="Button btn sm" id="btnSearchDatabase">조회</button>
							<button class="Button btn sm" id="btnAddDatabase">추가</button>
							<button class="Button btn sm" id="btnDeleteDatabase">삭제</button>
							<button class="Button btn sm bg-red" id="btnSaveDatabase">저장</button>
						</div>
					</div>
					<div id="gridDatabase" class="grid grid-line__wrap"></div>
				</div>
			</div>		
		</div>
	</div>
	<script type="text/javascript">
		var gNamespaces = null; // 네임스페이스 콤보
		var gForm = $('form[name=configForm]');
		var gIsUpdate = true;
		var gConfigData = null;
		$a.page(function() {
			this.init = function() {
				gNamespaces = gCommon.getNamespaceCombo($('#namespaces'),{incAdminAll:true})
				.addHandler(function(e) {
					gCommon.setSelectedNamespace(e.currentTarget.id);
				}).select({
					id : gSelectedNamespace
				});
				
				/*tabDatabase start Database*/
				let tabDatabase = $('#tabDatabase');
				let gridDatabase = $('#gridDatabase').alopexGrid({
					autoColumnIndex: true,
					autoResize:true,
					rowInlineEdit:true,
					rowSelectOption:{
						clickSelect : true,
						singleSelect : true
					},
					cellSelectable:true,
					restoreFocusOnInvalidInlineEdit :true,
					leaveDeleted:true,
					height: 400,
					columnMapping : [  
						{ title:'state',key:'state',width:'50px',editable:false,hidden:false,render:function(value,data){
							if (data._state.added){data.state = 'A'}
							else if (data._state.deleted){data.state='D'}
							else if (data._state.edited){data.state='E'}
							else {data.state=''}
							return data.state;
						}},
						{ title:'NAME', key : 'name' , width: '400px', align: 'left' ,editable:true	,allowEdit:function(value,data){
							return data._state.added == true;
						},editable: function(value, data) {
							return '<div><input type="text" class="alopexgrid-default-renderer" maxlength="15" value="'+value+'"/></div>'; 
						},editedValue: function(cell) {
							return $(cell).find('input').val();
						},valid : function(value, data) {
							if(value=='') {
								return false;
							}
							return true;
						}}
					], message: { nodata: gMessage.gridNodata }
				}).on('cellEditInvalid ', function(e){
					setTimeout(function(evt){
						let evObj = AlopexGrid.parseEvent(e);
						let opt = evObj.data;
						let mapping = evObj.mapping;
						let col = mapping.columnIndex;
						let invalidValue = evObj.value;
						
						if(opt._state.deleted == true){
							return;
						}
						if(col == 1){
							alert('DATABASE명을 입력하세요');
						}
						gridDatabase.alopexGrid('focusCell', opt);
						setTimeout(function(){
							gridDatabase.alopexGrid('rowSelect', opt, true)
							gridDatabase.find('.bodycell[data-alopexgrid-rowindex='+(opt._index.row)+'][data-alopexgrid-columnindex='+(opt._index.column)+'] input').focus();
						},100)
					},100)
				}).on('dataChanged',function(e){
					let isEnalbed = AlopexGrid.trimData(gridDatabase.alopexGrid('dataGet',{state:'E'},{state:'A'},{state:'D'})).length > 0;
					tabDatabase.find('#btnSaveUser').setEnabled(isEnalbed);
				});
				tabDatabase.find('#btnAddDatabase').on('click', function(e){
					gridDatabase.alopexGrid('endRowInlineEdit');
					let dt = gridDatabase.alopexGrid('dataGet');
					
					if(dt[0]._state.added == true && dt[0]._state.editing != false){ return; } 
					let opt = {_index :{row:0,column:1,data:0,target:0}};
					gridDatabase.alopexGrid('dataAdd', {}, opt);
					gridDatabase.alopexGrid('startRowInlineEdit',opt);
					setTimeout(function(){
						gridDatabase.alopexGrid('rowSelect', opt, true)
						gridDatabase.find('.bodycell[data-alopexgrid-rowindex=0][data-alopexgrid-columnindex=1] input').focus();
					},100)
				});
				tabDatabase.find('#btnDeleteDatabase').on('click',function(e){
					gridDatabase.alopexGrid('endRowInlineEdit');
					let dg = gridDatabase.alopexGrid( 'dataGet' , {_state:{selected:true}});
					if(dg.length == 0){
						gCommon.alert('선택된 행이 없습니다.');return;
					};
					let dt = dg[0];
					if(false){
						gCommon.alert('삭제 할 수 없습니다.');return;
					}
					let d = dt._state.deleted ? 'dataUndelete' : 'dataDelete'; 
					gridDatabase.alopexGrid(d,{_state: {selected:true}}); 
				})
				tabDatabase.find('#btnSearchDatabase').on('click',function(e){
					fn_getDatabases(); 
				})
				tabDatabase.find('#btnSaveDatabase').on('click',function(e){
					fn_saveDatabase();
				})
				function fn_getDatabases(){
					$a.ajax({
						url: '/zdbapi/getDatabases',
						method:'get',
						data: gParam,
						success: function(res){
							let list = res.databases;
							gridDatabase.alopexGrid('dataSet',list);
						}
					});				
				};			
				function fn_saveDatabase(){
					gridDatabase.alopexGrid('endRowInlineEdit');
					gCommon.confirm('변경된 정보를 저장하시겠습니까?',function(){
						let data = AlopexGrid.trimData(gridDatabase.alopexGrid('dataGet',{state:'E'},{state:'A'},{state:'D'}));
						if(data.length > 0){
							for(let i in data){
								let d = $.extend(data[i],gParam);
								d.databaseName = d.name;
							};
							$a.ajax({
								url: '/zdbapi/saveDatabase',
								method:'put',
								data: {data:JSON.stringify(data)},
								success: function(res){
									fn_getDatabases();
								}
							});	
						};						
					})
				};
				fn_getDatabases();
				/*tabDatabase end*/				
			}
		});
	</script>
</th:block>
</html>