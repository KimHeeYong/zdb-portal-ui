<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/content_layout">
<th:block layout:fragment="page_head">
    <title>서비스 목록</title>
</th:block>
<th:block layout:fragment="page_js">
	<script src="/script/app/common/cloudzdb-ui-z0200.js"></script>
</th:block>
<th:block layout:fragment="content">
<!-- location -->
<div class="locations-area">
	<div class="prj-list">
		<strong>Namespace : </strong>
		<button id="namespaces" class="Dropdownbutton namespace"></button>
		<ul class="dropmenu-list hide">
		</ul>
	</div>
</div>
<div class="contents-box">
<div class="top-area">
	<h2 class="title">서비스목록</h2>
	<div class="tag-wrap" id="tagArea">
		<span class="tag">태그:</span>
		<span class="Label Default">모든태그</span>
	</div>
	<div class="filter-wrap">
		<input id="txtServiceFilter" class="Textinput filter-input" placeholder="Keyword 입력">
		<!--오름차순 내림차순 아이콘이 있고 select만 하는 기능이라 dropdownbutton으로 적용함 -->
		<button class="Dropdownbutton filter-select serviceFilter" id="serviceSort">이름순</button>
		<ul class="dropmenu-list hide">
			<li class="dsc" id="sortNm">
				<a>이름순</a>
			</li>
			<li class="asc" id="sortSt">
				<a>서비스 종류순</a>
			</li>
			<li class="asc" id="sortUt">
				<a>구동일시순</a>
			</li>
			<li class="dsc" id="sortCt">
				<a>생성일시순</a>
			</li>
		</ul>
	</div>
</div>
<!-- accordion wrap-->
<ul class="Accordion db-accordion" id="divServiceList"> </ul>

<script type="text/javascript">

	var gSelectedNamespace = '';//선택된 네임스페이스
	var gSelectedTag = '';//선택된 태그
	var gNamespaces = null;     // 네임스페이스 콤보
	var gSelectedSort = '';    //선택된 정렬
	var gServiceList = [];      //서비스 목록
	var gTagList = [];
	$a.page(function() {
		this.init = function() {
			gSelectedNamespace = gParam.selectedNamespace||G_NAMESPACE_ALL;
			gNamespaces = gCommon.getNamespaceCombo($('#namespaces'))
						 .select({id:gParam.selectedNamespace||G_NAMESPACE_ALL})
						 .addHandler(function(e){
							  gSelectedNamespace = e.currentTarget.id;
							  gCommon.movePage('/zdb02/zdb0200',{selectedNamespace:gSelectedNamespace});
							  //fn_getServices();
						  }); 
			//정렬 콤보 설정
			gSelectedSort = $('#serviceSort~.dropmenu-list>li:first').attr('id');
			$('#serviceSort').addHandler(function(e){
				gSelectedSort = e.currentTarget.id;
				fn_displayServices();
			});
			//서비스 목록 조회 태그 선택
			$('body').on('click','#tagArea span.Label',function(){
				gSelectedTag = $(this).data('id')||'';
				fn_displayServices();
			});			
			$('#txtServiceFilter').on('input propertychange',function(){
				fn_displayServices();
			});
			//서비스 목록내 태그 삭제
			$('body').on('click','button.tagDel',function(){
				if(!confirm('선택한 태그를 삭제하시겠습니까?')){
					return;
				};
				var data = gCommon.findObjectByKeyOb(gTagList,{id:$(this).prev().data('id')});
				data = $.extend({},data,{serviceName:data.releaseName});
				$a.ajax({
					url: '/zdbapi/deleteTag',
					data: data, 
					success: function(res){
						gCommon.alert(gMessage.procSuccss);
						fn_getServices();
					}
				});
			});
			//서비스 목록내 태그 추가
			$('body').on('click','button.tagAdd',function(e){
				e.preventDefault();
				var data = $('#'+$(this).attr('key')).data();
			    $a.popup({
			        url: "/zdb02/zdb0200p01",
			        iframe: false,  // default 는 true
			        width: 500,
			        height: 450,
			        data:data,
			        title : "태그추가",
			        callback:function(result){
			        	if(result == "success"){
			        		fn_getServices();
			        	}
			        }
			    });
			});
			
			//서비스 목록 클릭
			$('body').on('click','.proc_serviceDetail',function(evt){
				var data = $('#'+$(this).attr('key')).data();
				if(data.status == 'gray'){
					gCommon.alert('서비스 준비 중입니다.');
					return;
				};
				gCommon.movePage('/zdb02/zdb0210',$.extend(data,{selectedNamespace:gSelectedNamespace}));
			});
			
			//서비스 목록 refresh 클릭
			$('body').on('click','.proc_serviceRestart',function(evt){
				var data = $('#'+$(this).attr('key')).data();
				$a.ajax({
					url: '/zdbapi/restartService',
					data : data,
					success: function(res){
						console.log(res);	
					}
				});
			});
			//서비스 목록 refresh 클릭
			$('body').on('click','.viewMonitor',function(evt){
				var data = $('#'+$(this).attr('key')).data();
				
				/*
				$a.ajax({
					url: '/zdbapi/restartService',
					data : data,
					success: function(res){
						console.log(res);	
					}
				});
				*/
			});

			fn_getServices();	
		};
		
		//서비스 목록 조회 && 태그 조회
		function fn_getServices(){
			var deferred = $.Deferred();
			$a.ajax({
				url: '/zdbapi/getServiceoverviews',
				data: {namespace:gSelectedNamespace} , 
				success: function(res){
					gServiceList = res.serviceoverviews;
					gfn_convertServiceDatas(gServiceList);
					gTagList = res.tags;
					var tagDiv = $('#tagArea').html('<span class="tag">태그:</span><span class="Label white">모든태그</span>'); 
					if(gTagList){
						for(var i = 0 ; i < gTagList.length;i++){
							var tag = gTagList[i];
							var tagSpan = $('<span class="Label white" data-id="'+tag.id+'">'+tag.tagName+'</span>');
							tagDiv.append(tagSpan);
						};
					};
					fn_displayServices();
				},
				complete:function(res){
					deferred.resolve(res.responseJSON)
				}
			});
			return deferred.promise();
		};
		//서비스 목록 display
		function fn_displayServices(){
			var serviceListDiv = $('#divServiceList');
			var dispServiceDiv = $('<div/>');
			
			var namespaces = fn_getViewNamespaces();
			var filterList = getFilterAndSortServices(gServiceList);
			
			for(var i = 0; i < namespaces.length; i++){
				var namespace = namespaces[i];
				dispServiceDiv.append('<li id="service'+namespace.id+'"><a>Namespace : <span>'+namespace.text+'</span></a><div class="accor-contents__wrap"></div></li>');
				var list = filterList[namespace.id];
				if(list){
					for(var j = 0; j < list.length;j++){
						var ob = list[j];
						var data = {
								namespace:ob.namespace,
								serviceType:ob.serviceType,
								serviceName:ob.serviceName,
								status:ob.status.toLowerCase(),
								version:ob.version,
								updTime:ob.updTime,
								statusMessage:ob.statusMessage||'',
								tagList:ob.tags
							};
						var tDiv = $(gfn_getServiceTemplate(data));
						dispServiceDiv.find('#service'+ob.namespace+" div.accor-contents__wrap").append(tDiv);
						gCommon.setDataAttrs(tDiv.find('.Panel-content[link]'),data);
					};
				};
				//서비스 생성 
				//dispServiceDiv.find('#service'+namespace.id+" div.accor-contents__wrap").append(gfn_getMakeServiceTemplate({namespace:namespace.id}));
			};
			//서비스 목록이 없는 네임스페이스 삭제
			dispServiceDiv.find('li[id^=service]').filter(function(){
				return $(this).find('.Panel-content[link]').size() == 0
			}).remove();
			
			serviceListDiv.html('');
			serviceListDiv.html(dispServiceDiv.html());
			serviceListDiv.refresh();
			serviceListDiv.expandAll();
			gCommon.removeOverlay();
			
			fn_displayTags();
		}
		function fn_displayTags(){
			var tagDiv = $('#tagArea'); 
			tagDiv.find('span.Label').removeClass('selected');
			/*
			tagDiv.find('span[data-id]').hide();
			$('.Panel-content[link] div.tag-wrap span[data-id]').each(function(){
				tagDiv.find('[data-id='+$(this).data('id')+']').show();
			});
			*/
			if(gSelectedTag!=''){
				tagDiv.find('[data-id='+gSelectedTag+']').addClass('selected');
			};
			if(tagDiv.find('span.Label.selected').size()==0){
				gSelectedTag = '';
				tagDiv.find('span.Label:first').addClass('selected');
			};
		}
		function getFilterAndSortServices(serviceList){
			var list = [];
			
			for(var i = 0;i < serviceList.length;i++){
				var ob = serviceList[i];
				if(gSelectedNamespace !== G_NAMESPACE_ALL && gSelectedNamespace !== ob.namespace){
					continue;
				};
				if(gSelectedTag!=''){
					var temp = gCommon.findObjectByKeyOb(gTagList,{id:gSelectedTag});
					var fTag = gCommon.findObjectByKeyOb(ob.tags,{tagName:temp.tagName});
					if(!fTag){
						continue;
					};
				};
				if($("#txtServiceFilter").val()!=''){
					if(ob.serviceName.toLowerCase().indexOf($("#txtServiceFilter").val().toLowerCase()) < 0){
						continue;
					};	
				};
				if(!list[ob.namespace]){
					list[ob.namespace] = [];
				}
				list[ob.namespace].push(ob);
			};				
			for(var key in list){
				var li = list[key];
				var val1 = '';
				var val2 = '';
				li.sort(function(a,b){  
					//오름차순이면 val1 = a, val2 = b 내림차순이면 val1 = b,val2 = a
					switch(gSelectedSort){
						case "sortNm": //이름 내림 
							val1 = b.serviceName;
							val2 = a.serviceName;
							break;   
						case "sortSt": // 서비스 오름
							val1 = a.serviceType;
							val2 = b.serviceType;
							break;
						case "sortUt": // 구동일시 오름
							val1 = b.lastTransitionTime;
							val2 = a.lastTransitionTime;
							break;
						case "sortCt": // 생성일시 내림
							val1 = b.crtTime;
							val2 = a.crtTime;
							break;
					}
					return(val1<val2)?-1:(val1>val2)?1:0; 
				});
			};
			return list;
		}
		function fn_getViewNamespaces(){
			var list = [];
			
			var namespaces = gNamespaces.getDataSource();
			if(gSelectedNamespace === G_NAMESPACE_ALL){
				list = namespaces.filter(function(ob){
					return ob.id !== G_NAMESPACE_ALL ;
				});
			}else{
				list = namespaces.filter(function(ob){
					return ob.id === gSelectedNamespace;
				});
			};
			return list;
		}
	});
</script>
</div>
	<!-- //contents -->
</th:block>
</html>