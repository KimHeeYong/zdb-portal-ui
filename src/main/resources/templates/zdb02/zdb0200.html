<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/content_layout">
<th:block layout:fragment="page_head">
    <title>서비스 목록</title>
</th:block>
<th:block layout:fragment="page_js">
	<script src="/script/app/common/cloudzdb-ui-z0200.js"></script>
</th:block>
<th:block layout:fragment="content">
<!-- location -->
<div class="locations-area">
	<div class="prj-list">
		<strong>Namespace : </strong>
		<button id="namespaces" class="Dropdownbutton namespace"></button>
		<ul class="dropmenu-list hide">
		</ul>
	</div>
</div>
<div class="contents-box">
<div class="top-area">
	<h2 class="title">서비스목록</h2>
	<div class="tag-wrap" id="tagArea">
		<span class="tag">태그:</span>
		<span class="Label Default">모든태그</span>
	</div>
</div>
<div class="search-wrap">
	<input class="Textinput srcinput" placeholder="검색어를 입력하세요." id="txtServiceFilter">
	<button class="Button btn-search" id="btnSearch">검색</button>
</div>	
<!-- accordion wrap-->
<!--namespace detail view-->
<div class="panel-line__wrap">
	<!-- namespace sorting-->
	<div class="namespace-sort">
		<div class="sort-button">
			<button class="Button btn-ico__typeb btn-cardview Checked">카드형으로 보기</button>
			<button class="Button btn-ico__typeb btn-listview">목록형으로 보기</button>
			<div class="Tooltip hide" data-position="bottom">추후제공 예정입니다.</div>
		</div>
		<ul class="sort-list">
			<li data-sort-name="shortServiceName" class="asc">이름</li>
			<li data-sort-name="serviceType">서비스종류</li>
			<li data-sort-name="lastTransitionTime">구동시간</li>
			<li data-sort-name="status">상태</li>
		</ul>
	</div>
	<div id="divServiceList"> </div>
</div>
<style>
.btn-ico {
	cursor: pointer;
	text-indent: -9999px;
	width: 24px;
	height: 24px;
	border: 0;
	background: transparent url("/styles/images/ico-btn.png") no-repeat;
}
.Button.btn-ico.btn-del__typeb:hover, .Button.btn-ico.btn-del__typeb:active,
.btn-ico.btn-del__typeb:hover, .btn-ico.btn-del__typeb:active {
	background: transparent url("/styles/images/ico-btn.png") no-repeat;
	background-position: -314px -58px;
}
.Button.btn-ico.btn-del__typeb, .btn-ico.btn-del__typeb {
	background: transparent url("/styles/images/ico-btn.png") no-repeat;
	background-position: -278px -58px;
}
.btn-ico.btn-refresh {background-position: -32px -178px;}
</style>
<script type="text/javascript">

	var gSelectedTag = '';//선택된 태그
	var gNamespaces = null;     // 네임스페이스 콤보
	var gServiceList = [];      //서비스 목록
	var gTagList = [];
	$a.page(function() {
		this.init = function() {
			gNamespaces = gCommon.getNamespaceCombo($('#namespaces'))
						 .addHandler(function(e){
							  gCommon.setSelectedNamespace(e.currentTarget.id);
							  fn_getServices();
						  }) 
						 .select({id:gSelectedNamespace});
			var sortLi = $('.sort-list li'); 
			sortLi.on('click',function(evt){
				var tCss = $(this).attr('class') == 'asc' ? 'dsc' : 'asc';
				sortLi.attr('class','').filter(this).attr('class',tCss);
				fn_displayServices();
			});
			//서비스 목록 조회 태그 선택
			$('body').on('click','#tagArea span.Label',function(){
				gSelectedTag = $(this).data('id')||'';
				fn_displayServices();
			});			
			$('#txtServiceFilter').on('input propertychange',function(){
				fn_displayServices();
			});
			//서비스 목록내 태그 삭제
			$('body').on('click','button.tagDel',function(){
				var ob = $(this).prev();
				gCommon.confirm('선택한 태그를 삭제하시겠습니까?',function(){
					var data = gCommon.findObjectByKeyOb(gTagList,{id:ob.data('id')});
					data = $.extend({},data,{serviceName:data.releaseName});
					$a.ajax({
						url: '/zdbapi/deleteTag',
						data: data, 
						success: function(res){
							gCommon.alert(gMessage.procSuccss);
							fn_getServices();
						}
					});
				})
			});
			//서비스 목록내 태그 추가
			$('body').on('click','button.tagAdd',function(e){
				e.preventDefault();
				var data = $('#'+$(this).attr('key')).data();
				$(this).next().show().find('input').focus();
			});
			$('body').on('keypress','input.tagAddInput',function(evt){
				if(evt.which == '13'){
					var data = $('#'+$(this).attr('key')).data();
		    		data = $.extend({},data,{releaseName:data.serviceName,tagName:$(this).val()});
					$a.ajax({
						url: '/zdbapi/createTag',
						data: data, 
						success: function(res){
				    		gCommon.alert(gMessage.saveSuccess);
				    		fn_getServices();
						}
					});
				};
			}).on('focusout','input.tagAddInput',function(){
				$(this).val('').parent().hide();
			});
			
			//서비스 목록 클릭
			$('body').on('click','.proc_serviceDetail,.viewMonitor',function(evt){
				var data = $('#'+$(evt.target).attr('key')).data();
				if(!data)return;
				if(data.status == 'gray'){
					gCommon.alert('서비스 준비 중입니다.');
					return;
				};
				var param = $.extend({},data,{});
				if($(evt.target).hasClass('viewMonitor')){
					param.goMoniter = 'Y';
				};
				gCommon.movePage('/zdb02/zdb0210',param);
			});
			
			//서비스 목록 refresh 클릭
			$('body').on('click','.proc_serviceRestart',function(evt){
				gCommon.confirm('서비스를 재시작 하시겠습니까?',function(){
					var data = $('#'+$(evt.target).attr('key')).data();
					$a.ajax({
						url: '/zdbapi/restartService',
						data : data,
						success: function(res){
							if(res.result.code == '0'){
								fn_getServices();	
							};
						}
					});
				})
			}).on('click','.proc_serviceDelete',function(evt){
				gCommon.confirm('서비스를 삭제 하시겠습니까?',function(){
					var data = $('#'+$(evt.target).attr('key')).data();
					$a.ajax({
						url: '/zdbapi/deleteServiceInstance',
						data:data,
						success: function(res){
							gCommon.alert('삭제 요청이 완료 되었습니다.',function(){
								fn_getServices();
							});
						}
					})
				})
			});
			
			$('#btnSearch').on('click',function(){
				fn_getServices();
			});
			$('#txtServiceFilter').pressEnter(function(){
				fn_getServices();
			});
		};
		
		//서비스 목록 조회 && 태그 조회
		function fn_getServices(){
			var deferred = $.Deferred();
			$a.ajax({
				url: '/zdbapi/getServiceoverviews',
				data: {namespace:gSelectedNamespace} , 
				success: function(res){
					gServiceList = res.serviceoverviews;
					gfn_convertServiceDatas(gServiceList);
					gTagList = res.tags;
					tagDiv = $('#tagArea').html('<span class="tag">태그:</span> <span class="Label white">모든태그</span>'); 
					if(gTagList){
						for(var i = 0 ; i < gTagList.length;i++){
							var tag = gTagList[i];
							var tagSpan = $('<span class="Label white" data-id="'+tag.id+'">'+tag.tagName+'</span>');
							if((tagDiv).find('span').filter(function() { return $(this).text() == tag.tagName; }).size()==0){
								tagDiv.append(tagSpan);
							};
						};
					};
					fn_displayServices();
				},
				complete:function(res){
					deferred.resolve(res.responseJSON)
				}
			});
			return deferred.promise();
		};
		//서비스 목록 display
		function fn_displayServices(){

			fn_displayTags();
			var serviceListDiv = $('#divServiceList');
			var dispServiceDiv = $('<div/>');
			
			var namespaces = fn_getViewNamespaces();
			var filterList = getFilterAndSortServices(gServiceList);
			
			for(var i = 0; i < filterList.length; i++){
				var namespace = namespaces[i];
				var ob = filterList[i];
				var data = {
						namespace:ob.namespace,
						serviceType:ob.serviceType,
						serviceName:ob.serviceName,
						shortServiceName:ob.shortServiceName,
						status:ob.status.toLowerCase(),
						version:ob.version,
						updTime:ob.updTime,
						elapsedTime:ob.elapsedTime,
						statusMessage:ob.statusMessage||'',
						tagList:ob.tags
					};
				var tDiv = $(gfn_getServiceTemplate(data));
				dispServiceDiv.append(tDiv);
				gCommon.setDataAttrs(tDiv.find('.Panel-content[link]'),data);
			};
			
			serviceListDiv.html('');
			serviceListDiv.html(dispServiceDiv.html());
			$a.convert(serviceListDiv.find('.Tooltip'));
			gCommon.removeOverlay();
		}
		function fn_displayTags(){
			var tagDiv = $('#tagArea'); 
			tagDiv.find('span.Label').removeClass('selected');
			
			if(gSelectedTag!=''){
				tagDiv.find('[data-id='+gSelectedTag+']').filter(':visible').addClass('selected');
			};
			if(tagDiv.find('span.Label.selected').size()==0){
				gSelectedTag = '';
				tagDiv.find('span.Label:first').addClass('selected');
			};
		}
		function getFilterAndSortServices(serviceList){
			var list = [];
			
			for(var i = 0;i < serviceList.length;i++){
				var ob = serviceList[i];
				if(gSelectedNamespace !== G_NAMESPACE_ALL && gSelectedNamespace !== ob.namespace){
					continue;
				};
				if(gSelectedTag!=''){
					var temp = gCommon.findObjectByKeyOb(gTagList,{id:gSelectedTag});
					var fTag = gCommon.findObjectByKeyOb(ob.tags,{tagName:temp.tagName});
					if(!fTag){
						continue;
					};
				};
				if($("#txtServiceFilter").val()!=''){
					if(ob.serviceName.toLowerCase().indexOf($("#txtServiceFilter").val().toLowerCase()) < 0){
						continue;
					};	
				};
				list.push(ob);
			};				
			var sOb = $('.sort-list li').filter('[class=asc],[class=dsc]');
			var selectedSort = sOb.data('sortName');
			var sortType = sOb.attr('class');
			list.sort(function(a,b){  
				//오름차순이면 val1 = a, val2 = b 내림차순이면 val1 = b,val2 = a
				var val1 = a[selectedSort];
				var val2 = b[selectedSort];
				if(sortType == 'asc'){
					return(val1<val2)?-1:(val1>val2)?1:0; 
				}else{
					return(val2<val1)?-1:(val2>val1)?1:0;
				};
			});
			return list;
		}
		function fn_getViewNamespaces(){
			var list = [];
			
			var namespaces = gNamespaces.getDataSource();
			if(gSelectedNamespace === G_NAMESPACE_ALL){
				list = namespaces.filter(function(ob){
					return ob.id !== G_NAMESPACE_ALL ;
				});
			}else{
				list = namespaces.filter(function(ob){
					return ob.id === gSelectedNamespace;
				});
			};
			return list;
		}
	});
</script>
</div>
	<!-- //contents -->
</th:block>
</html>