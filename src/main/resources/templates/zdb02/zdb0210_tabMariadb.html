<div id="tabMariadb">
	<div class="Tabs">
		<div class="tabs-contents bn">
			<div class="lay-item__box">
				<div style="width:180px;" class="dtc" id="divMariaMenu">
					<ul class="dropmenu-list bbn" style="height:600px;">
						<li class="selected" data-menu="databaseStatus">서버상태</li>
						<li data-menu="connection">클라이언트 커넥션</li>
						<li data-menu="userRole">사용자 및 권한관리</li>
						<li data-menu="statusVariables">Status Variables</li>
						<li data-menu="systemVariables">System Variables</li>
						<li data-menu="myCnf">my.cnf</li>
					</ul>
				</div>
				<div id="divMariaContent">
					<div style="padding-left:10px;padding-right:10px;">
						<div data-menu="databaseStatus">
							<table class="Table Form-type">
								<colgroup>
									<col width="150px"></col>
									<col width="200px"></col>
									<col width="*"></col>
								</colgroup>
								<tr>
									<th rowspan="6" align="center"><img src="/styles/images/service-img-big-mariadb.png"></th>
									<th>Host:</th>
									<td data="hostname"></td>
								</tr>	
								<tr>
									<th>Socket:</th>
									<td data="socket"></td>
								</tr>	
								<tr>
									<th>Port:</th>
									<td data="port"></td>
								</tr>	
								<tr>
									<th>Version:</th>	
									<td data="version"></td>
								</tr>	
								<tr>
									<th>Compiled For:</th>
									<td data="compiled"></td>
								</tr>	
								<tr>
									<th>Running Since:</th>
									<td data="running"></td>
								</tr>	
							</table>
							<h3 class="form-title">Server Directories</h3>
							<table class="Table Form-type">
								<colgroup>
									<col width="200px">
									<col width="*">
								</colgroup>
								<tr>
									<th>Base Directory:</th>
									<td data="basedir"></td>
								</tr>
								<tr>
									<th>Data Directory:</th>
									<td data="datadir"></td>
								</tr>
								<tr>
									<th>Plugin Directory:</th>
									<td data="plugin_dir"></td>
								</tr>
								<tr>
									<th>Tmp Directory:</th>
									<td data="tmpdir"></td>
								</tr>
								<tr>
									<th>Error Log:</th>
									<td data="log_error"></td>
								</tr>
								<tr>
									<th>General Log:</th>
									<td data="generalLog"></td>
								</tr>
								<tr>
									<th>Slow Query Log:</th>
									<td data="slowQueryLog"></td>
								</tr>
							</table>
						</div>
						<div data-menu="connection" class="hide">
							<h3 class="form-title">Client Connections</h3>
							<div class="row">
								<div class="cols wd300"> Threads Connected <span class="ml20" data="Threads_connected"></span> </div>
								<div class="cols wd300"> Threads Running  <span class="ml20" data="Threads_running"></span> </div>
								<div class="cols wd300"> Threads Created  <span class="ml20" data="Threads_created"></span> </div>
								<div class="cols wd300"> Threads Cached  <span class="ml20" data="Threads_cached"></span> </div>
								<div class="cols wd300"> Rejected(over limit) <span class="m20" data="Connection_errors_max_connections"></span></div>
								<div class="cols wd300"> Total Connections  <span class="ml20" data="Connections"></span></div>
								<div class="cols wd300"> Connection Limit  <span class="ml20" data="max_connections"></span></div>
								<div class="cols wd300"> Aborted Clients  <span class="ml20" data="Aborted_clients"></span></div>
								<div class="cols wd300"> Aborted Connections  <span class="ml20" data="Aborted_connects"></span></div>
								<div class="cols wd300"> errors</div>
							</div>
							<div id="gridConnection"></div>
						</div>
						<div data-menu="userRole" class="hide">
							<h3 class="form-title">Users and Privileges</h3>
							<div class="fl" style="width:230px;">
								<div id="gridUserRole"></div>
							</div>
							<div style="width:calc(100% - 300px);min-height:600px;overflow: scroll">
								<form name="formUserRole">
						 		<table class="Table Form-type" style="min-width:900px;width:900px;border-bottom:0px;">
									<colgroup>
										<col style="width:190px"></col>
										<col style="width:230px"></col>
										<col style="width:480px"></col>
									</colgroup>
									<tbody>
										<tr> 
											<td>Login Name:</td>
											<td>
												<input class="Textinput" type="text" id="user" name="user">
												<p data-for="user" class="warn-text"></p>
											</td>
											<td>You may create multiple accounts with the same name<br/>to the connect from different hosts. </td>
										</tr>
										<tr> 
											<td>Authentication Type:</td>
											<td>
												<div class="Divselect">
													<select>
														<option value="Standard">Standard</option>
													</select>
													<span></span>
												</div>
											</td>
											<td>For the standard password and/or host based authentication<br/>select 'Standard'.</td>
										</tr>
										<tr> 
											<td>Limit to Hosts Matching:</td>
											<td>
												<input class="Textinput" type="text" id="host" name="host">
												<p data-for="host" class="warn-text"></p>
											</td>
											<td>% and_wildcards may be used</td>
										</tr>										
										<tr> 
											<td>Password:</td>
											<td>
												<input class="Textinput" type="password" id="password" name="password">
												<p data-for="password" class="warn-text"></p>
											</td>
											<td>Type a password to reset it.</td>
										</tr>										
										<tr> 
											<td>Confirm Password:</td>
											<td>
												<input class="Textinput" type="password" id="passwordConfirm" name="passwordConfirm">
												<p data-for="passwordConfirm" class="warn-text"></p>
											</td>
											<td>Enter password again to confirm</td>
										</tr>										
									</tbody>
								</table>
						 		<table class="Table Form-type" style="min-width:900px;width:900px;border-top:0px;">
									<colgroup>
										<col style="width:300px"></col>
										<col style="width:300px"></col>
										<col style="width:300px"></col>
									</colgroup>
									<tbody>
										<tr>
											<td>
												Object Rights
												<div class="item-wrap2">
													<ul>
														<li><input class="Checkbox" type="checkbox" name="select" value="Y">SELECT</li>
														<li><input class="Checkbox" type="checkbox" name="insert" value="Y">INSERT</li>
														<li><input class="Checkbox" type="checkbox" name="update" value="Y">UPDATE</li>
														<li><input class="Checkbox" type="checkbox" name="delete" value="Y">DELETE</li>
														<li><input class="Checkbox" type="checkbox" name="execute" value="Y">EXECUTE</li>
														<li><input class="Checkbox" type="checkbox" name="showView" value="Y">SHOW VIEW</li>
													</ul>
												</div>
											</td>
											<td>
												DDL Rights
												<div class="item-wrap2">
													<ul>
														<li><input class="Checkbox" type="checkbox" name="create" value="Y">CREATE</li>
														<li><input class="Checkbox" type="checkbox" name="alter" value="Y">ALTER</li>
														<li><input class="Checkbox" type="checkbox" name="references" value="Y">REFERENCES</li>
														<li><input class="Checkbox" type="checkbox" name="index" value="Y">INDEX</li>
														<li><input class="Checkbox" type="checkbox" name="createView" value="Y">CREATE VIEW</li>
														<li><input class="Checkbox" type="checkbox" name="createRoutine" value="Y">CREATE ROUTINE</li>
														<li><input class="Checkbox" type="checkbox" name="alterRoutine" value="Y">ALTER ROUTINE</li>
														<li><input class="Checkbox" type="checkbox" name="event" value="Y">EVENT</li>
														<li><input class="Checkbox" type="checkbox" name="drop" value="Y">DROP</li>
														<li><input class="Checkbox" type="checkbox" name="trigger" value="Y">TRIGGER</li>
													</ul>
												</div>
											</td>
											<td>
												Other Rights
												<div class="item-wrap2">
													<ul>
														<li><input class="Checkbox" type="checkbox" name="grant" value="Y">GRANT OPTION</li>
														<li><input class="Checkbox" type="checkbox" name="createTmpTable" value="Y">CREATE TEMPORARY TABLES</li>
														<li><input class="Checkbox" type="checkbox" name="lockTables" value="Y">LOCK TABLES</li>
													</ul>
												</div>
											</td>
										</tr>
									</tbody>
								</table>
								</form>															 	
							 </div>
						</div>
						<div data-menu="statusVariables">
							<div class="search-wrap tr fi">
								<input id="txtStatusVariablesFilter" name="txtStatusVariablesFilter" class="Textinput srcinput" placeholder="검색어를 입력하세요.">
							</div>
							<div id="gridStatusVariables"></div>
						</div>
						<div data-menu="systemVariables" class="hide">
							<div class="search-wrap tr fi">
								<input id="txtSystemVariablesFilter" name="txtSystemVariablesFilter" class="Textinput srcinput" placeholder="검색어를 입력하세요.">
							</div>
							<div id="gridSystemVariables"></div>
						</div>
						<div data-menu="myCnf" class="hide">
							<div class="btn-wrap">
								<div class="btn-right">
									<button class="Button btn bg-red" id="btnSaveMyCnf" style="margin-bottom: 3px;">저장</button>
								</div>
							</div>								
							<div id="gridMyCnf"></div>
						</div>
					</div>
				</div>
			</div>		
		</div>
	</div>
</div>
<script type="text/javascript">
gService = {
	podName :"zdb-test-mat-mariadb-0"
}
let appMariadb = {
	init : function(){
		this.tabMariadb = $('#tabMariadb');
		this.mariaMenu = this.tabMariadb.find('#divMariaMenu');
		this.mariaContent = this.tabMariadb.find('#divMariaContent');
		
		this.mariaMenu.find('li').on('click',function(e){
			let ob = $(e.currentTarget)
			ob.parent().find('li').removeClass('selected');
			ob.addClass('selected');
			let menuName = $(ob).data('menu');
			appMariadb.mariaContent.find('[data-menu]').hide().filter('[data-menu='+menuName+']').show();
			appMariadb.initMenu(menuName);
		})
		//appMariadb.initMenu(appMariadb.mariaContent.find('[data-menu]:eq(0)').data('menu'));
		
		appMariadb.getDatabaseVariables();
		setTimeout(function(){
			appMariadb.mariaMenu.find('[data-menu]:eq(2)').trigger('click')
		},100)
		function fn_isSystemProcess(data){
			let exIds = ['system user','replicator']; 
			return exIds.indexOf(data.User) > -1; 
		}			
		this.gridConnection = $('#gridConnection').alopexGrid({
			rowOption : { 
				styleclass : function(data, rowOption){
					let re = '';
					let state = (data.State||'').toLowerCase();
					let time = (data.Time || 0);
					if(!fn_isSystemProcess(data)){
						if( state.indexOf('waiting for') > -1 || 
								   (state.indexOf('sending data') > -1 && time >= 10) ||
								   (state.indexOf('updating') > -1 && time >= 10) ||
								   (state == 'copying to tmp table on disk')){
							re = 'warning-color';
						}
					}
					
					return re;
				}
			},				
			message: { nodata: gMessage.gridNodata },
			autoColumnIndex : true,
			columnMapping : [
					{ key : 'Id', title : 'Id', width : '70px', align : 'center'},
					{ key : 'User', title : 'User', width : '80px', align : 'left' },
					{ key : 'Host', title : 'Host', width : '80px', align : 'center' },
					{ key : 'db', title : 'DB', width : '100px', align : 'center' },
					{ key : 'Command', title : 'Command', width : '100px', align : 'center' },
					{ key : 'Time', title : 'Time', width : '100px', align : 'center'},
					{ key : 'State', title : 'State', width : '130px', align : 'center'},
					{ key : 'Info', title : 'Info', width : '250px', align : 'left'},
					{ key : '', title : '', width : '80px', align : 'center',render:function(value,data){
						let disabled = '';
						if(fn_isSystemProcess(data) == true){
							disabled = 'Disabled';
						}
						return $('<button class="Button sm '+disabled+'">종료</button>').on('click',function(){
							if($(this).hasClass('Disabled')){
								return;
							}
							gCommon.credentialConfirm({
						        data:{credential:$("#credential").val(),msg:'프로세스를 종료하시려면',okBtnMsg:'종료'},
						        callback : function(res){
									$a.ajax({
										url: '/zdbapi/killProcess',
										data:$.extend({},gParam,{pid:data.Id,podName:gService.podName}),
										success: function(res){
											if(res.result.code == '0'){
												appMariadb.getConnection();
											}
										}
									})
						        }
						    });
						});
					}}
					],
			});
		this.formUserRole = appMariadb.mariaContent.find('form[name=formUserRole]');
		this.gridUserRole = $('#gridUserRole').alopexGrid({
			autoColumnIndex : true,
			width:220,
			height:580,
			message: { nodata: gMessage.gridNodata },
			autoColumnIndex : true,
			rowSelectOption: {
				clickSelect: true,
				singleSelect: true
			},			
			columnMapping : [
				{ key : 'user', title : 'User', width : '100px', align : 'left' },
				{ key : 'host', title : 'From Host', width : '120px', align : 'left' }					
			]
		}).on('click', '.bodycell', function(e){
			let dt = AlopexGrid.parseEvent(e).data;
			appMariadb.formUserRole[0].reset();
			appMariadb.formUserRole.zdbui_setContents(dt);
		});			
		this.gridStatusVariables = $('#gridStatusVariables').alopexGrid({
			height:580,
			message: { nodata: gMessage.gridNodata },
			autoColumnIndex : true,
			columnMapping : [
				{ key : 'name', title : 'name', width : '500px', align : 'left',excludeFitWidth:true },
				{ key : 'value', title : 'Value', width : '500px', align : 'left',excludeFitWidth:true}	,
				{ key:''}
			]
		});			
		appMariadb.tabMariadb.find('[data-menu=statusVariables] input[name=txtStatusVariablesFilter]').on('input propertychange',function(){
			appMariadb.setStatusVariablesFilter();
		});
		
		this.gridSystemVariables = $('#gridSystemVariables').alopexGrid({
			height:580,
			message: { nodata: gMessage.gridNodata },
			autoColumnIndex : true,
			columnMapping : [
				{ key : 'name', title : 'name', width : '500px', align : 'left',excludeFitWidth:true },
				{ key : 'value', title : 'Value', width : '500px', align : 'left',excludeFitWidth:true },
				{ key:'',title:''}
			]
		});				
		appMariadb.tabMariadb.find('[data-menu=systemVariables] input[name=txtSystemVariablesFilter]').on('input propertychange',function(){
			appMariadb.setSystemVariablesFilter();
		});	

		this.gridMyCnf = $('#gridMyCnf').alopexGrid({
			rowInlineEdit:true,
			rowSelectOption:{
				clickSelect : true,
				singleSelect : true
			},
			rowOption : { 
				styleclass : function(data, rowOption){
					console.log(data.categoryColumn);
					if(data.categoryColumn==true) return 'header-row';
				}
			},			
			restoreFocusOnInvalidInlineEdit :true,
			cellSelectable:true,
			leaveDeleted:true,			
			readonlyRender:false,
			tree : {
				 useTree : true
				,idKey : 'name' //노드를 지시하는 유일한 값이 저장된 키값
				,parentIdKey : 'category' //자신의 상위(parent) 노드를 지시하는 ID가 저장된 키값
				,expandedKey : 'expandedCategory'
			},			
			height:580,
			message: { nodata: gMessage.gridNodata },
			autoColumnIndex : true,
			columnMapping : [
				{ key : 'status' , title : '', width:'50px',excludeFitWidth:true},
				{ key : 'category', title : 'category', width : '400px', align : 'left',hidden:true,excludeFitWidth:true },
				{ key : 'name', title : 'Config Name', width : '400px', align : 'left', treeColumn : false ,render:mycnfRender ,editable:mycnfEditable,excludeFitWidth:true},
				{ key : 'value', title : 'Value', width : '350px', align : 'left',render:mycnfRender,editable:mycnfEditable,editedValue: function(cell, data, render, mapping, grid) {
					let re = $(cell).find('select,input').val();
					return re;
				},valid : function(value, data) {
					let re = true;
					if(!appMariadb.validMyCnf(value,data)){
						re = false;
						value = data.value;
					}					
					data.valid = re;
					return re;
				},excludeFitWidth:true},					
				{ key : 'description', title : 'Description', width : '300px', align : 'left' },
				{ key : 'proc', title : '', width : '100px', align : 'left',render: mycnfRender,excludeFitWidth:true }
			]
		}).on('cellEditInvalid ', function(e){
			setTimeout(function(evt){
				var evObj = AlopexGrid.parseEvent(e);
				var opt = evObj.data;
				var mapping = evObj.mapping;
				var col = mapping.columnIndex;
				
				if(opt._state.deleted == true){
					return;
				}
				alert('입력값을 확인하세요.');
				appMariadb.gridMyCnf.alopexGrid('focusCell', opt);
				
				setTimeout(function(){
					appMariadb.gridMyCnf.alopexGrid('rowSelect', opt, true)
					let input = appMariadb.gridMyCnf.find('.bodycell[data-alopexgrid-rowindex='+(opt._index.row)+'][data-alopexgrid-columnindex='+(opt._index.column)+'] input');
					input.focus().trigger('click');
				},100)
			},100)
		});	
		
		$('#btnSaveMyCnf').on('click',function(){
			appMariadb.saveGridMyCnf();
		})
		//mycnf grid의 보여주는 컬럼 설정
		function mycnfRender(){
			let re = '';
			let value = arguments[0];
			let data = arguments[1];
			let column = arguments[3];
			let grid = arguments[4];
			let arg = arguments;
			let isAddVariableColumn = data.addVariableColumn == true;
			switch(column.key){
				case 'name':
					if(data.categoryColumn==true){
						re = '<span style="font-size:1.5em;color:midnightblue">['+value+']</span>';
					} else if(isAddVariableColumn){
						re = getAddVariableColumn(data);
					} else re = data.alias;
					break;
				case 'value':
					re = value;	
					if(data.category && data.name){
						let dbv = appMariadb.databaseVariables;
						let o = dbv[data.category][data.name];
						if(o.dataType == 'enumerationkv'){
							let c = eval('/'+data.value+':([^,]*)/').exec(o.valueRange);
							if(c)re=c[1];						
						}
					}
					break;
				case 'proc':
					if(isAddVariableColumn){
						re = $('<button class="Button btn sm">추가</button>').on('click',function(e){
							appMariadb.gridMyCnf.alopexGrid('endRowInlineEdit');
							appMariadb.gridMyCnf.alopexGrid('dataGet');
							let evt = AlopexGrid.parseEvent(e);
							let dt = AlopexGrid.trimData(evt.data);
							if(dt.valid == false)return;
							let newList = AlopexGrid.trimData(appMariadb.gridMyCnf.alopexGrid('dataGet',{dataColumn:true}));
							if(cloudUtil.isEmpty(dt.name) || dt.name == gMessage.selectAddColumn){
								gCommon.alert(gMessage.selectAddColumn);return;
							}
							newList.push({
								category:dt.category, name:dt.name, value:dt.value, dataColumn:true
							});
							appMariadb.setGridMyCnf(newList);
							appMariadb.gridMyCnf.alopexGrid('focusCell',{category:dt.category,name:dt.name})
						});
					} else if(!cloudUtil.isEmpty(data.category)){
						re = $('<button class="Button btn sm">삭제</button>').on('click',function(e){
							appMariadb.gridMyCnf.alopexGrid('endRowInlineEdit');
							let evt = AlopexGrid.parseEvent(e);
							let dt = evt.data;
							if(dt.serverData==true){
								let d = dt._state.deleted ? 'dataUndelete' : 'dataDelete'; 
								appMariadb.gridMyCnf.alopexGrid(d,evt.data);
							}else{
								let gridList = AlopexGrid.trimData(appMariadb.gridMyCnf.alopexGrid('dataGet',{dataColumn:true}));
								let l = gridList.filter(function(o){
									return !(o.category == dt.category && o.name == dt.name)  
								});
								appMariadb.setGridMyCnf(l); 
							}
						});
					}
					break;
				default :	
					re = value;
					break;
			}
			return re;			
		}
		//mycnf grid 수정 상태일때 보여주는 컬럼 설정
		function mycnfEditable(){
			let re = '';
			let value = arguments[0];
			let data = arguments[1];
			let column = arguments[3];
			let isAddVariableColumn = data.addVariableColumn == true;
			switch(column.key){
				case 'name':
					if(data.categoryColumn==true)re = '<span style="font-size:1.5em;color:midnightblue">['+value+']</span>';
					else if(isAddVariableColumn){
						re = getAddVariableColumn(data);
					} else re = data.alias;
					break;
				case 'value':
					if(!data.dataColumn && !isAddVariableColumn)return;
					let dbv = appMariadb.databaseVariables;
					let d = dbv[data.category][data.name]||{};
					if(d && d.dynamic == true){
						let valueRange = d.valueRange|| ''; 
						if(d.dataType.indexOf('enumeration')>-1){
							let l = valueRange.split(',');
							re = $('<div class="Divselect wd250" style="top:-5px;height:32px;"><select></select><span></div>');
							if(d.dataType == 'enumerationkv'){
								for(let i = 0; i < l.length;i++){
									let v = l[i].split(':');
									re.find('select').append($('<option/>',{text:v[1],value:v[0]}));
								}
							}else if(d.dataType == 'enumeration'){
								for(let i = 0; i < l.length;i++){
									re.find('select').append($('<option/>',{text:l[i],value:l[i]}));
								}
							}							
							
							$a.convert(re);
							if(cloudUtil.isEmpty(data.value)){
								let firstValue = re.find('select option:eq(0)').val();
								appMariadb.gridMyCnf.alopexGrid('dataEdit', $.extend({},data,{value:firstValue}),data);
								data.value = firstValue;
							}
							re.setSelected(data.value);
						}else{
							re = '<input type="text" class="Textinput" value="'+(data.value||'')+'" style="top:-5px;height:32px; width:80%">';
						}
					}else{
						re = '';
					}
				break;
			}
			return re;
		}
		//mycnf grid 추가 컬럼 설정
		function getAddVariableColumn(data){
			let re = $('<div class="Divselect wd250" style="top:-5px;height:32px;"><select><option>'+gMessage.selectAddColumn+'</option></select><span></div>');
			for(let i = 0 ; i < data.comboList.length;i++){
				let o = data.comboList[i];
				re.find('select').append($('<option/>',{text:o.alias,value:o.name}));
			}
			$a.convert(re);
			re.setSelected(data.name).find('select').on('change',function(evt){
				let dbv = appMariadb.databaseVariables;
				let name = $(evt.currentTarget).val();
				let o = dbv[data.category][name];
				let d = $.extend({},o,{value:''});
				appMariadb.gridMyCnf.alopexGrid('dataEdit', d,data);
				appMariadb.gridMyCnf.alopexGrid('rowSelect', data, true);
				appMariadb.gridMyCnf.alopexGrid('startRowInlineEdit',data);
			});
			return re
		}

		},initMenu : function(menuName){
			switch(menuName){
				case 'databaseStatus':
					appMariadb.getDatabaseStatus();
					break;
				case 'connection':
					appMariadb.getProcesses();
					appMariadb.getDatabaseConnection();
					break;
				case 'userRole':
					appMariadb.getUserRoleList();
					break;
				case 'statusVariables':
					appMariadb.getStatusVariables();
					break;
				case 'systemVariables':
					appMariadb.getSystemVariables();
					break;
				case 'myCnf':
					appMariadb.getMyCnfList();
					break;
			}
			appMariadb.mariaContent.find('[data-menu]:visible .alopexgrid').alopexGrid('viewUpdate')
		},getDatabaseStatus : function(){
			let d = $.extend({},gParam,{podName:gService.podName});
			$a.ajax({
				url:'/zdbapi/getDatabaseStatus',
				data:d,
				success:function(res){
					ds = res.databaseStatus;
					let onOffBtn = {
						ON : '<span class="state green vm"></span> ',
						OFF : '<span class="state inactive vm"></span> '
					}
					if(ds && ds.compiled){
						ds.compiled = ds.version_compile_os + '('+ds.version_compile_machine+')';
						ds.running = moment(ds.timestamp * 1000).format('ddd MMM D HH:mm:ss YYYY');
						BigNumber.config({ ROUNDING_MODE: BigNumber.ROUND_DOWN });
						let ut = new BigNumber(ds.Uptime);
						let utStr = '';
						let day = ut.div(86400).integerValue();
						if(day.isGreaterThan(0)){
							ut = ut.minus(day.times(86400)); 
						}
						let hour = ut.div(3600).integerValue();
						if(hour.isGreaterThan(0)){
							ut = ut.minus(hour.times(3600));
						}
						let minute = ut.div(60).integerValue();
						utStr += day.toNumber() + ' days ' + hour.toNumber()+ ' : ' +minute.toNumber();
						
						ds.running += ' ( ' + utStr + ' )' 
						ds.generalLog = onOffBtn[ds.general_log] + ds.general_log;
						ds.slowQueryLog = onOffBtn[ds.slow_query_log] + ds.slow_query_log + ' ' + ds.slow_query_log_file;
						
						appMariadb.tabMariadb.find('[data-menu=databaseStatus]').zdbui_setContents(ds);
					}
				}
			});
		}, getDatabaseConnection :function(){
			$a.ajax({
				url:'/zdbapi/getDatabaseConnection',
				data:$.extend({},gParam,{podName:gService.podName}),
				success:function(res){
					let d = res.databaseConnection;
					appMariadb.tabMariadb.find('[data-menu=connection]').zdbui_setContents(d);
				}
			});			
		}, getProcesses : function(){
			$a.ajax({
				url:'/zdbapi/getProcesses',
				data:$.extend({},gParam,{podName:gService.podName}),
				success:function(res){
					let list = res.processes;
					appMariadb.gridConnection.alopexGrid('dataSet',list);
				}
			});
		}, getStatusVariables : function(){
			$a.ajax({
				url:'/zdbapi/getDatabaseStatusVariables',
				data:$.extend({},gParam,{podName:gService.podName}),
				success:function(res){
					let d = res.databaseStatusVariables;
					let list = [];
					for(let k in d){
						list.push({name:k,value:d[k]});
					}
					appMariadb.gridStatusVariables.alopexGrid('dataSet',list);
				}
			});
		}, setStatusVariablesFilter:function(){
			let v = appMariadb.tabMariadb.find('[data-menu=statusVariables] input[name=txtStatusVariablesFilter]').val();
			if(cloudUtil.isEmpty(v)){
				appMariadb.gridStatusVariables.alopexGrid('clearFilter');
			}else{
				v = v.toLowerCase();
				appMariadb.gridStatusVariables.alopexGrid('setFilter','statusVariablesFilter',function(dt){
					return dt.name.toLowerCase().indexOf(v) > -1 || dt.value.toLowerCase().indexOf(v) > -1   
				});
			}			
		}, getSystemVariables : function(){
			$a.ajax({
				url:'/zdbapi/getDatabaseSystemVariables',
				data:$.extend({},gParam,{podName:gService.podName}),
				success:function(res){
					let d = res.databaseSystemVariables;
					let list = [];
					for(let k in d){
						list.push({name:k,value:d[k]});
					}
					appMariadb.gridSystemVariables.alopexGrid('dataSet',list);
				}
			});
		}, setSystemVariablesFilter:function(){
			let v = appMariadb.tabMariadb.find('[data-menu=systemVariables] input[name=txtSystemVariablesFilter]').val();
			if(cloudUtil.isEmpty(v)){
				appMariadb.gridSystemVariables.alopexGrid('clearFilter');
			}else{
				v = v.toLowerCase();
				appMariadb.gridSystemVariables.alopexGrid('setFilter','systemVariablesFilter',function(dt){
					return dt.name.toLowerCase().indexOf(v) > -1 || dt.value.toLowerCase().indexOf(v) > -1   
				});
			}			
		}, getDatabaseVariables:function(){ 
			appMariadb.databaseVariables = {};//mycnf 환경 변수
			$a.ajax({
				url:'/zdbapi/getDatabaseVariables',
				data:gParam,
				success:function(res){
					let dt = {};
					let list = res.databaseVariables||[];
					for(let i = 0; i < list.length;i++){
						let o = list[i];
						if(!dt[o.category]){
							dt[o.category]= {};
						}
						dt[o.category][o.name] = o;
					}
					appMariadb.databaseVariables = dt;
				}
			});			
		}
		, getUserRoleList:function(){
			$a.ajax({
				url: '/zdbapi/getUserGrants',
				method:'get',
				data: gParam,
				success: function(res){
					let list = res.userGrants;
					appMariadb.gridUserRole.alopexGrid('dataSet',list);
				}
			});
		}
		, getMyCnfList : function(){
			//서버에 설정된 mycnf 내용 조회
			$a.ajax({
				url:'/zdbapi/getUseDatabaseVariables',
				data:gParam,
				success:function(res){
					let myCnfList = res.databaseVariables||[];
					let l = myCnfList.map(function(ob){
						return $.extend({},ob,{serverData:true});
					});
					appMariadb.setGridMyCnf(l);					
				}
			})
		}, 
		/*
			mycnfgrid 에 데이터 설정  : serverData(true,false)컬럼으로 실제 데이터 판별 ,dataColumn(true,false)으로 데이터 여부 판별
			category 데이터,실데이터,추가콤보 리스트 순으로 생성( 파라미터는 실데이터)		
		*/
		setGridMyCnf : function(paramList){
			let categoryList = [{name:'mysqld'},{name:'mysql'},{name:'mysqld_safe'},{name:'mysqldump'},{name:'client'}];
			categoryList = categoryList.map(function(ob){
				return $.extend({},ob,{serverData:false,dataColumn:false,categoryColumn:true});
			});
			let gridList = categoryList.slice(); //마지막에 보여줄 전체 grid 리스트
			let comboList = {}; //카테고리별 추가 데이터
			
			let dbv = appMariadb.databaseVariables;
			for(let cg in dbv){
				let ds = dbv[cg];
				for(let name in ds){
					let o = ds[name];				
					let mc = gCommon.findObjectByKeyOb(paramList,{category:o.category,name:o.name});
					//전달 받은 데이터에 있으면 grid리스트에,없으면 추가콤보로 생성
					if(mc==null){
						if(comboList[o.category]==null){
							comboList[o.category] = [];
						}
						comboList[o.category].push(o);							
					}else{
						mc.dataColumn = true;
						gridList.push($.extend({},mc,o,{value:mc.value}));
					}
				}
			}
			
			for(let k in comboList){
				let o = comboList[k];
				gridList.push({category:k, name:'' ,addVariableColumn:true ,comboList:o,dataColumn:false,serverData:false});
			}
			appMariadb.gridMyCnf.alopexGrid('dataSet',gridList).alopexGrid('expandTreeNode');			
		},saveGridMyCnf : function(){
			appMariadb.gridMyCnf.alopexGrid('endRowInlineEdit');
			let dt = AlopexGrid.trimData(appMariadb.gridMyCnf.alopexGrid('dataGet',function(data) {
			    return data.dataColumn == true && data._state.deleted != true;
			}));
			if(gCommon.findObjectByKeyOb(dt,{valid:false}) !=null){
				return;
			};
			gCommon.confirm("설정을 변경하시겠습니까?",function(){
				let param = $.extend({},gParam,{databaseVariables:JSON.stringify(dt)});
				$a.ajax({
					url:'/zdbapi/updateUseDatabaseVariables',
					method:'put',
					data:param,
					success:function(res){
						if(res.result.code == 0){
							gCommon.alert('설정이 변경되었습니다.');
							appMariadb.getMyCnfList();
						}
					}
				});
			})
		},validMyCnf:function(value,data){
			let re = true;
			if(data.dataType == 'numeric') {
				let valueRange = (data.valueRange||'').split(':');
				if(valueRange.length > 1){
					let val = (value||'').toUpperCase();
					let reg = /^([\d]+)([K|M]{0,1})$/gi.exec(val);
					if(reg==null){
						return false;
					}
					let n = new BigNumber(reg[1]);
					let unit = 1;
					if(reg[2] == 'K'){
						unit = 1024;
					}else if(reg[2] == 'M'){
						unit = 1024 * 1024
					}
					let r = n.times(unit);
					let min = new BigNumber(valueRange[0]);
					let max = new BigNumber(valueRange[1]);
				    re = (min.isNaN()|| r.gte(min)) && (max.isNaN() || r.lte(max));
				}
			}
			return re;
		} 
	}
$a.page(function() {
	this.init = function() {
		appMariadb.init();		
	}
});

</script>
