<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" 
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/content_layout">
<th:block layout:fragment="page_head">
	<title th:text="#{label.zdb0721.title.header}"></title>
</th:block>
<th:block layout:fragment="page_css">
</th:block>
<th:block layout:fragment="content">
	<!-- Location -->
	<div class="locations-area">
		<div class="prj-list">
			<strong>Namespace : </strong>
			<button id="namespaces" class="Dropdownbutton namespace"></button>
			<ul class="dropmenu-list hide">
			</ul>
		</div>
	</div>
	<!-- Contents -->
	<div class="contents-box">
		<!-- Top Area -->
		<div id="tabDatabase">
			<!-- rule info area-->
			<div class="top-area">
				<h2 th:text="#{label.zdb0721.title.top}" class="title"></h2>
				<div class="tag-wrap">
					<span th:text="#{label.zdb0721.tag.top}" class="tag"></span>
				</div>
			</div>
			<!-- add rule table-->
			<form name="ruleForm" onsubmit="return false;">
				<fieldset>
					<table class="Table Form-type topline" style="border-collapse: unset;" >
						<colgroup>
							<col style="width: 100px;" />
							<col style="width: 150px;" />
							<col style="width: 250px;" />
							<col style="width: 400px;" />
							<col style="width: 300px;" />
						</colgroup>
						<tbody>
							<tr>
								<th colspan="2"></th>
								<th th:text="#{label.zdb0721.table.usage.status}" class="tcenter"></th>
								<th th:text="#{label.zdb0721.table.severity}" class="tcenter"></th>
								<th th:text="#{label.zdb0721.table.threshold.range}" class="tcenter"></th>
							</tr>
							<tr>
								<th th:text="#{label.zdb0721.table.health}" rowspan="3"></th>
								<th><span th:text="#{label.zdb0721.table.pod}"></span>
									<span class="ico_title" id="podTooltip"></span>
									<div th:text="#{label.zdb0721.tooltip.pod}" class="Tooltip" data-base="#podTooltip" data-position="right" data-animation="fade">
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="PodHealthCheck-useYn" value="Y"/><span th:text="#{label.zdb0721.table.use}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="PodHealthCheck-useYn" value="N" checked="checked"/><span th:text="#{label.zdb0721.table.unused}"></span></label> 
								</td>
								<td colspan="2">	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="PodHealthCheck-priority" value="P4" checked="checked" /><span th:text="#{label.zdb0721.table.low}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="PodHealthCheck-priority" value="P3"/><span th:text="#{label.zdb0721.table.warning}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="PodHealthCheck-priority" value="P1" /><span th:text="#{label.zdb0721.table.critical}"></span></label>
								</td>
							</tr>
							<tr>
								<th><span th:text="#{label.zdb0721.table.container}"></span>
									<span class="ico_title" id="containerTooltip"></span>
									<div th:text="#{label.zdb0721.tooltip.container}" class="Tooltip" data-base="#containerTooltip" data-position="right" data-animation="fade">
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ContainerHealthCheck-useYn" value="Y"/><span th:text="#{label.zdb0721.table.use}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ContainerHealthCheck-useYn" value="N" checked="checked"/><span th:text="#{label.zdb0721.table.unused}"></span></label> 
								</td>
								<td colspan="2">	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ContainerHealthCheck-priority" value="P4" checked="checked" /><span th:text="#{label.zdb0721.table.low}"></span></label>
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ContainerHealthCheck-priority" value="P3"/><span th:text="#{label.zdb0721.table.warning}"></span></label>  
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ContainerHealthCheck-priority" value="P1" /><span th:text="#{label.zdb0721.table.critical}"></span></label>
								</td>
							</tr>
							<tr>
								<th><span th:text="#{label.zdb0721.table.db}"></span>
									<span class="ico_title" id="dbTooltip"></span>									
									<div th:text="#{label.zdb0721.tooltip.db}" class="Tooltip" data-base="#dbTooltip" data-position="right" data-animation="fade">
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="DBHealthCheck-useYn" value="Y"/><span th:text="#{label.zdb0721.table.use}"></span></label>
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="DBHealthCheck-useYn" value="N" checked="checked" /><span th:text="#{label.zdb0721.table.unused}"></span></label> 
								</td>
								<td colspan="2">	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="DBHealthCheck-priority" value="P4" checked="checked" /><span th:text="#{label.zdb0721.table.low}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="DBHealthCheck-priority" value="P3"/><span th:text="#{label.zdb0721.table.warning}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="DBHealthCheck-priority" value="P1" /><span th:text="#{label.zdb0721.table.critical}"></span></label>
								</td>
							</tr>
							<tr>
								<th th:text="#{label.zdb0721.table.usage}" rowspan="4"></th>
								<th><span th:text="#{label.zdb0721.table.cpu}"></span>
									<span class="ico_title" id="cpuTooltip"></span>
									<div th:text="#{label.zdb0721.tooltip.cpu}" class="Tooltip" data-base="#cpuTooltip" data-position="right" data-animation="fade"></div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="CPUUsage-useYn" value="Y"/><span th:text="#{label.zdb0721.table.use}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="CPUUsage-useYn" value="N" checked="checked" /><span th:text="#{label.zdb0721.table.unused}"></span></label> 
								</td>
								<td>	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="CPUUsage-priority" value="P4" checked="checked" /><span th:text="#{label.zdb0721.table.low}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="CPUUsage-priority" value="P3"/><span th:text="#{label.zdb0721.table.warning}"></span></label>
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="CPUUsage-priority" value="P1" /><span th:text="#{label.zdb0721.table.critical}"></span></label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="CPUUsage-condition" id="CPUUsage-condition">
											<option value="&gt;">&gt;</option>
										</select><span></span>
									</div>
									<div style="position: relative; display: inline-block;">
										<input class="Textinput" type="text" style="width: 120px; display: block; padding-right: 30px; min-width: 50px; top:2px;" maxlength="3" name="CPUUsage-value2" id="CPUUsage-value2" data-keyfilter-rule="digits"/>
										<span style="position: absolute; top: 0; right: 0; display: block; width: 30px; height: 100%; text-align: center; line-height: 30px; top:2px;" >%</span>	
									</div>
									<span>(Default:80%)</span>									
									<p class="warn-text" data-for="CPUUsage-value2"></p>									
								</td>
							</tr>
							<tr>
								<th><span th:text="#{label.zdb0721.table.memory}"></span>
									<span class="ico_title" id="memoryTooltip"></span>
									<div th:text="#{label.zdb0721.tooltip.memory}" class="Tooltip" data-base="#memoryTooltip" data-position="right" data-animation="fade"></div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="MemoryUsage-useYn" value="Y"/><span th:text="#{label.zdb0721.table.use}"></span></label>
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="MemoryUsage-useYn" value="N" checked="checked"/><span th:text="#{label.zdb0721.table.unused}"></span></label> 
								</td>
								<td>	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="MemoryUsage-priority" value="P4" checked="checked"/><span th:text="#{label.zdb0721.table.low}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="MemoryUsage-priority" value="P3"/><span th:text="#{label.zdb0721.table.warning}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="MemoryUsage-priority" value="P1"/><span th:text="#{label.zdb0721.table.critical}"></span></label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="MemoryUsage-condition" id="MemoryUsage-condition">
											<option value="&gt;">&gt;</option>
										</select> <span></span>
									</div>
									<div style="position: relative; display: inline-block;">
										<input class="Textinput" type="text" style="width: 120px; display: block; padding-right: 30px; min-width: 50px; top:2px;" maxlength="3" name="MemoryUsage-value2" id="MemoryUsage-value2" data-keyfilter-rule="digits" />
										<span style="position: absolute; top: 0; right: 0; display: block; width: 30px; height: 100%; text-align: center; line-height: 30px; top:2px; " >%</span>	
									</div>
									<span>(Default:95%)</span>									
									<p class="warn-text" data-for="MemoryUsage-value2"></p>											
								</td>
							</tr>
							<tr>
								<th><span th:text="#{label.zdb0721.table.connections}"></span>
									<span class="ico_title" id="connectionTooltip"></span>
									<div th:text="#{label.zdb0721.tooltip.connections}" class="Tooltip" data-base="#connectionTooltip" data-position="right" data-animation="fade"></div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="Connections-useYn" value="Y"/><span th:text="#{label.zdb0721.table.use}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="Connections-useYn" value="N" checked="checked"/><span th:text="#{label.zdb0721.table.unused}"></span></label>
								</td>
								<td>	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="Connections-priority" value="P4" checked="checked" /><span th:text="#{label.zdb0721.table.low}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="Connections-priority" value="P3"/><span th:text="#{label.zdb0721.table.warning}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="Connections-priority" value="P1" /><span th:text="#{label.zdb0721.table.critical}"></span></label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="Connections-condition" id="Connections-condition">
											<option value="&gt;">&gt;</option>
										</select> <span></span>
									</div>
									<div style="position: relative; display: inline-block;">
										<input class="Textinput" type="text" style="width: 120px; display: block; padding-right: 30px; min-width: 50px; top:2px;" maxlength="3" name="Connections-value2" id="Connections-value2" data-keyfilter-rule="digits"/>
										<span style="position: absolute; top: 0; right: 0; display: block; width: 30px; height: 100%; text-align: center; line-height: 30px; top:2px;" >%</span>	
									</div>
									<span>(Default:80%)</span>										
									<p class="warn-text" data-for="Connections-value2"></p>									
								</td>
							</tr>
							<tr th:if="${#request.getParameter('serviceType')} == 'mariadb'" >
								<th><span th:text="#{label.zdb0721.table.slowquery}"></span>
									<span class="ico_title" id="slowQueryTooltip"></span>
									<div th:utext="#{label.zdb0721.tooltip.slowquery}" class="Tooltip" data-base="#slowQueryTooltip" data-position="right" data-animation="fade"></div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="SlowQueries-useYn" value="Y"/><span th:text="#{label.zdb0721.table.use}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="SlowQueries-useYn" value="N" checked="checked"/><span th:text="#{label.zdb0721.table.unused}"></span></label> 
								</td>
								<td>	
									<label class="ImageRadio"><input class="Radio" type="radio" name="SlowQueries-priority" value="P4" checked="checked" /><span th:text="#{label.zdb0721.table.low}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="SlowQueries-priority" value="P3"/><span th:text="#{label.zdb0721.table.warning}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="SlowQueries-priority" value="P1" /><span th:text="#{label.zdb0721.table.critical}"></span></label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="SlowQueries-condition" id="SlowQueries-condition">
											<option value="&gt;">&gt;</option>
										</select> <span></span>
									</div>
									<input class="Textinput" type="text" style="width: 120px; min-width: 50px;" maxlength="3" name="SlowQueries-value2" id="SlowQueries-value2" data-keyfilter-rule="decimal" />									
									<span>(Default:0.1)</span>		
									<p class="warn-text" data-for="SlowQueries-value2"></p>									
								</td>
							</tr>
							<tr th:if="${#request.getParameter('serviceType')} == 'mariadb'" >
								<th th:text="#{label.zdb0721.table.replication}" rowspan="2"></th>
								<th>
									<span th:text="#{label.zdb0721.table.status}"></span>
									<span class="ico_title" id="statusTooltip"></span>
									<div th:utext="#{label.zdb0721.tooltip.status}" class="Tooltip" data-base="#statusTooltip" data-position="right" data-animation="fade"></div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ReplicationStatus-useYn" value="Y"/><span th:text="#{label.zdb0721.table.use}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationStatus-useYn" value="N" checked="checked"/><span th:text="#{label.zdb0721.table.unused}"></span></label> 
								</td>
								<td colspan="2">	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ReplicationStatus-priority" value="P4" checked="checked" /><span th:text="#{label.zdb0721.table.low}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationStatus-priority" value="P3"/><span th:text="#{label.zdb0721.table.warning}"></span></label>
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationStatus-priority" value="P1" /><span th:text="#{label.zdb0721.table.critical}"></span></label>
								</td>
							</tr>
							<tr th:if="${#request.getParameter('serviceType')} == 'mariadb'">
								<th>Delay
									<span th:text="#{label.zdb0721.table.delay}"></span>								
									<span class="ico_title" id="delayTooltip"></span></strong>
									<div th:utext="#{label.zdb0721.tooltip.delay}" class="Tooltip" data-base="#delayTooltip" data-position="right" data-animation="fade"></div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ReplicationDelay-useYn" value="Y"/><span th:text="#{label.zdb0721.table.use}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationDelay-useYn" value="N" checked="checked"/><span th:text="#{label.zdb0721.table.unused}"></span></label> 
								</td>
								<td>	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ReplicationDelay-priority" value="P4" checked="checked" /><span th:text="#{label.zdb0721.table.low}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationDelay-priority" value="P3"/><span th:text="#{label.zdb0721.table.warning}"></span></label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationDelay-priority" value="P1" /><span th:text="#{label.zdb0721.table.critical}"></span></label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="ReplicationDelay-condition" id="ReplicationDelay-condition">
											<option value="&gt;">&gt;</option>
										</select> <span></span>
									</div>
									<div style="position: relative; display: inline-block;">
										<input class="Textinput" type="text" style="width: 120px; display: block; padding-right: 35px; min-width: 50px; top:2px;" maxlength="3" name="ReplicationDelay-value2" id="ReplicationDelay-value2" data-keyfilter-rule="digits" />
										<span th:text="#{label.zdb0721.inputbox.sec}" style="position: absolute; top: 0; right: 0; display: block; width: 35px; height: 100%; text-align: center; line-height: 30px; top:2px;" ></span>	
									</div>
									<span>(Default:0 s)</span>											
									<p class="warn-text" data-for="ReplicationDelay-value2"></p>									
								</td>
							</tr>
							<tr></tr>							
						</tbody>
					</table>
				</fieldset>
				<div class="btn-wrap">
					<div class="btn-left">
						<button th:text="#{label.common.button.list}" class="Button btn" id="btnRuleCancel"></button>
					</div>
					<div class="btn-right">
						<button th:text="#{label.common.button.confirm}" class="Button btn bg-red" id="btnRuleSave"></button>
					</div>
				</div>				
			</form>
		</div>
	</div>
	<script type="text/javascript">
		let gNamespaces = null;
		let gServiceData = {};
		let gRules = [];
		let ruleForm = $('form[name=ruleForm]');
		$a.page(function() {
			this.init = function() {
				let isUpdate = !cloudUtil.isEmpty(gParam.alert);
				
				Validator.addMethod('ifRequire', function(element, value, ob) {
					let b = true;
				    if($('input[name='+ob+']:checked').val() == 'Y'){
				    	b = !cloudUtil.isEmpty(value); 
				    }
				    return b;
				});
				let valElements = {}
				ruleForm.find('input[name$=-useYn]:checked').each(function(index,item){
					let type = item.name.split('-')[0];
					valElements[type+'-value2'] = {
						rule : {required:true,ifRequire:item.name},
						message : {ifRequire:'임계치를 입력하세요.'}
					}
				});
				
				ruleForm.validator({
				    elements :valElements
				}).validate();
				gCommon.getNamespaceCombo($('#namespaces')).done(function(selector){
					gNamespaces = selector.select({id:gSelectedNamespace})
										 .addHandler(function(e) {
											  gCommon.setSelectedNamespace(e.currentTarget.id);
											  gCommon.movePage('/zdb07/zdb0720',{selectedNamespace:gSelectedNamespace});
										  });
				});
			
				ruleForm.find('#btnRuleCancel').on('click',function(){
					location.href='/zdb07/zdb0720'
				});
				ruleForm.find('#btnRuleSave').on('click',function(){
					fn_saveAlertRule();
				});
				ruleForm.find('input[name$=-useYn]').on('change',function(){
					fn_setEnabled();	
				});

				fn_getAlertRule();
				fn_setEnabled();
				
				function fn_getAlertRule(){
					$a.ajax({
						url:'/zdbapi/getAlertRulesInService',
						data:gParam,
						success:function(res){
							let ruleList = res.alertRules;
							$('input[name$=value2]').val('');
							if(ruleList != null){ // length 사용중 이상 현상 발생으로 수정 (2019-07-15)
								for(let i = 0;i < ruleList.length;i++){
									let o = ruleList[i];
									let type = o.type.split('-')[2];
									$('input[name='+type+'-useYn][value=Y]').setSelected('Y');
									$('input[name='+type+'-priority][value='+o.priority+']').setSelected(o.priority);
									$('select[name='+type+'-condition]').val(o.condition);
									$('input[name='+type+'-value2]').val(o.value2);
								}
							}
						}
					})
				}
				function fn_saveAlertRule(){
					if(ruleForm.find('p[data-for]:visible.invalid').length > 0){
						return;
					};

					let data = $.extend({},gParam);
					let alertRules = [];
		    		
		    		ruleForm.find('input[name$=-useYn][value=Y]:checked').each(function (index, item) {
		    			let type = item.name.replace('-useYn','');
		    			let priority = $('input[name='+type+'-priority]:checked').val();
		    			let condition = $('select[name='+type+'-priority]').val();
		    			let value2 = $('input[name='+type+'-value2]').val();
		    			let d = {
		    				type : type,
		    				namespace : data.namespace,
		    				serviceName : data.serviceName,
		    				serviceType : data.serviceType,
		    				priority : priority,
		    				condition : condition,
		    				value2 : value2
		    			}
		    			alertRules.push(d);
		    		});
		    		data.alertRules = JSON.stringify(alertRules);

		    		
 					gCommon.confirm('저장 하시겠습니까?',function(){
						$a.ajax({
			    			url : '/zdbapi/updateAlertRule',
			    			method : 'put',
			    			data : data,
		    				success:function(res){
		    					if(res.result.code == '0000'){
		    						gCommon.alert('저장되었습니다.');
		    						fn_getAlertRule();
		    					}
		    				}
			    		});				
					}); 
				}

				function fn_setEnabled(){
					ruleForm.find('input[name$=-useYn]:checked').each(function (index, item) {
						let type = item.name.replace('-useYn','');
						let useYn = item.value == 'Y';
						
						$('input[name='+type+'-priority]').setEnabled(useYn);
		    			$('input[name='+type+'-value2]').setEnabled(useYn);
		    			if(useYn){
			    			$('p.warn-text[data-for='+type+'-value2]').removeClass('hide');
		    			}else{
			    			$('p.warn-text[data-for='+type+'-value2]').addClass('hide');
		    			}
					});
				}
			}
		});
	</script>
</th:block>
</html>