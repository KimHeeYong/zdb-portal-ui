<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" 
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/content_layout">
<th:block layout:fragment="page_head">
	<title>규칙관리</title>
</th:block>
<th:block layout:fragment="page_css">
</th:block>
<th:block layout:fragment="content">
	<!-- Location -->
	<div class="locations-area">
		<div class="prj-list">
			<strong>Namespace : </strong>
			<button id="namespaces" class="Dropdownbutton namespace"></button>
			<ul class="dropmenu-list hide">
			</ul>
		</div>
	</div>
	<!-- Contents -->
	<div class="contents-box">
		<!-- Top Area -->
		<div id="tabDatabase">
			<!-- rule info area-->
			<div class="top-area">
				<h2 class="title">규칙 설정</h2>
				<div class="tag-wrap">
					<span class="tag">알람 발생을 위한 규칙을 설정합니다.</span>
				</div>
			</div>
			<!-- add rule table-->
			<form name="ruleForm" onsubmit="return false;">
				<fieldset>
					<table class="Table Form-type topline" style="border-collapse: unset;" >
						<colgroup>
							<col style="width: 100px;" />
							<col style="width: 150px;" />
							<col style="width: 250px;" />
							<col style="width: 400px;" />
							<col style="width: 300px;" />
						</colgroup>
						<tbody>
							<tr>
								<th colspan="2"></th>
								<th class="tcenter">사용여부</th>
								<th class="tcenter">심각도</th>
								<th class="tcenter">임계치</th>
							</tr>
							<tr>
								<th rowspan="3">Health</th>
								<th>
									Pod<span class="ico_title" id="podTooltip"></span></strong>
									<div class="Tooltip" data-base="#podTooltip" data-position="right" data-animation="fade">
										Pod의 동작 상태를 확인하여 동작하지 않을 시 알람이 발생합니다.												
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="PodHealthCheck-useYn" value="Y"/>사용 </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="PodHealthCheck-useYn" value="N" checked="checked"/>미사용 </label> 
								</td>
								<td colspan="2">	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="PodHealthCheck-priority" value="P4" checked="checked" />Low </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="PodHealthCheck-priority" value="P3"/>Warning </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="PodHealthCheck-priority" value="P1" />Critical </label>
								</td>
							</tr>
							<tr>
								<th>Container<span class="ico_title" id="containerTooltip"></span></strong>
									<div class="Tooltip" data-base="#containerTooltip" data-position="right" data-animation="fade">
										Container의 동작 상태를 점검하여 Container 중단시 알람이 발생합니다.						
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ContainerHealthCheck-useYn" value="Y"/>사용 </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ContainerHealthCheck-useYn" value="N" checked="checked"/>미사용 </label> 
								</td>
								<td colspan="2">	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ContainerHealthCheck-priority" value="P4" checked="checked" />Low </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ContainerHealthCheck-priority" value="P3"/>Warning </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ContainerHealthCheck-priority" value="P1" />Critical </label>
								</td>
							</tr>
							<tr>
								<th>DB<span class="ico_title" id="dbTooltip"></span></strong>									
									<div class="Tooltip" data-base="#dbTooltip" data-position="right" data-animation="fade">
										DB의 동작 상태를 확인하여 DB 중단시 알람이 발생합니다.						
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="DBHealthCheck-useYn" value="Y"/>사용 </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="DBHealthCheck-useYn" value="N" checked="checked" />미사용 </label> 
								</td>
								<td colspan="2">	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="DBHealthCheck-priority" value="P4" checked="checked" />Low </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="DBHealthCheck-priority" value="P3"/>Warning </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="DBHealthCheck-priority" value="P1" />Critical </label>
								</td>
							</tr>
							<tr>
								<th rowspan="4">사용량</th>
								<th>CPU<span class="ico_title" id="cpuTooltip"></span></strong>
									<div class="Tooltip" data-base="#cpuTooltip" data-position="right" data-animation="fade">
										CPU 사용률(현재 CPU 사용량 / 전체 CPU 용량)이 설정한 임계치를 초과하면 알람이 발생합니다.						
									</div></th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="CPUUsage-useYn" value="Y"/>사용 </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="CPUUsage-useYn" value="N" checked="checked" />미사용 </label> 
								</td>
								<td>	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="CPUUsage-priority" value="P4" checked="checked" />Low </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="CPUUsage-priority" value="P3"/>Warning </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="CPUUsage-priority" value="P1" />Critical </label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="CPUUsage-condition" id="CPUUsage-condition">
											<option value="&gt;">&gt;</option>
										</select> <span></span>
									</div>
									<input class="Textinput" type="text" style="width: 120px; min-width: 50px;" maxlength="3" name="CPUUsage-value2" id="CPUUsage-value2" />
									<p class="warn-text" data-for="CPUUsage-value2"></p>									
								</td>
							</tr>
							<tr>
								<th>Memory<span class="ico_title" id="memoryTooltip"></span></strong>
									<div class="Tooltip" data-base="#memoryTooltip" data-position="right" data-animation="fade">
										Memory 사용률(현재 Memory 사용량 / 전체 Memory 용량)이 설정한 임계치를 초과하면 알람이 발생합니다.						
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="MemoryUsage-useYn" value="Y"/>사용 </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="MemoryUsage-useYn" value="N" checked="checked"/>미사용 </label> 
								</td>
								<td>	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="MemoryUsage-priority" value="P4" checked="checked"/>Low </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="MemoryUsage-priority" value="P3"/>Warning </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="MemoryUsage-priority" value="P1"/>Critical </label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="MemoryUsage-condition" id="MemoryUsage-condition">
											<option value="&gt;">&gt;</option>
										</select> <span></span>
									</div>
									<input class="Textinput" type="text" style="width: 120px; min-width: 50px;" maxlength="3" name="MemoryUsage-value2" id="MemoryUsage-value2" />
									<p class="warn-text" data-for="MemoryUsage-value2"></p>									
								</td>
							</tr>
							<tr>
								<th>Connections<span class="ico_title" id="connectionTooltip"></span></strong>
									<div class="Tooltip" data-base="#connectionTooltip" data-position="right" data-animation="fade">
										Connection 사용률(현재 Connection 수 / 전체 Connection 수)이 설정한 임계치를 초과하면 알람이 발생합니다.
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="Connections-useYn" value="Y"/>사용 </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="Connections-useYn" value="N" checked="checked"/>미사용 </label> 
								</td>
								<td>	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="Connections-priority" value="P4" checked="checked" />Low </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="Connections-priority" value="P3"/>Warning </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="Connections-priority" value="P1" />Critical </label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="Connections-condition" id="Connections-condition">
											<option value="&gt;">&gt;</option>
										</select> <span></span>
									</div>
									<input class="Textinput" type="text" style="width: 120px; min-width: 50px;" maxlength="3" name="Connections-value2" id="Connections-value2" />
									<p class="warn-text" data-for="Connections-value2"></p>									
								</td>
							</tr>
							<tr th:if="${#request.getParameter('serviceType')} == 'mariadb'" >
								<th>SlowQuery<span class="ico_title" id="slowQueryTooltip"></span></strong>
									<div class="Tooltip" data-base="#slowQueryTooltip" data-position="right" data-animation="fade">
										기준시간(2분) 동안 발생한 Slow Query의 수가 설정한 임계치를 초과하면 알람이 발생합니다.
										<br>임계치 설정은 임의의 Slow Query의 수 / 100 으로 입력하여야 합니다.
										<br>예) "10회" → 10 / 100 = 0.1 입력			
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="SlowQueries-useYn" value="Y"/>사용 </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="SlowQueries-useYn" value="N" checked="checked"/>미사용 </label> 
								</td>
								<td>	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="SlowQueries-priority" value="P4" checked="checked" />Low </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="SlowQueries-priority" value="P3"/>Warning </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="SlowQueries-priority" value="P1" />Critical </label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="SlowQueries-condition" id="SlowQueries-condition">
											<option value="&gt;">&gt;</option>
										</select> <span></span>
									</div>
									<input class="Textinput" type="text" style="width: 120px; min-width: 50px;" maxlength="3" name="SlowQueries-value2" id="SlowQueries-value2" />
									<p class="warn-text" data-for="SlowQueries-value2"></p>									
								</td>
							</tr>
							<tr th:if="${#request.getParameter('serviceType')} == 'mariadb'" >
								<th rowspan="2">Replication</th>
								<th>Status<span class="ico_title" id="statusTooltip"></span></strong>
									<div class="Tooltip" data-base="#statusTooltip" data-position="right" data-animation="fade">
										이중화된 경우 Slave의 Master 복제 상태를 확인하여 정상적으로 수행되지 않을 시 알람이 발생합니다.						
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ReplicationStatus-useYn" value="Y"/>사용 </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationStatus-useYn" value="N" checked="checked"/>미사용 </label> 
								</td>
								<td colspan="2">	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ReplicationStatus-priority" value="P4" checked="checked" />Low </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationStatus-priority" value="P3"/>Warning </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationStatus-priority" value="P1" />Critical </label>
								</td>
							</tr>
							<tr th:if="${#request.getParameter('serviceType')} == 'mariadb'">
								<th>Delay<span class="ico_title" id="delayTooltip"></span></strong>
									<div class="Tooltip" data-base="#delayTooltip" data-position="right" data-animation="fade">
										이중화된 경우 Slave의 Master 복제 중 지연 발생 시 알람이 발생합니다.						
									</div>
								</th>
								<td>
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ReplicationDelay-useYn" value="Y"/>사용 </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationDelay-useYn" value="N" checked="checked"/>미사용 </label> 
								</td>
								<td>	
									<label class="ImageRadio"> <input class="Radio" type="radio" name="ReplicationDelay-priority" value="P4" checked="checked" />Low </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationDelay-priority" value="P3"/>Warning </label> 
									<label class="ImageRadio Margin-left-40"> <input class="Radio" type="radio" name="ReplicationDelay-priority" value="P1" />Critical </label>
								</td>
								<td>
									<div class="Divselect" data-disabled="true">
										<select name="ReplicationDelay-condition" id="ReplicationDelay-condition">
											<option value="&gt;">&gt;</option>
										</select> <span></span>
									</div>
									<input class="Textinput" type="text" style="width: 120px; min-width: 50px;" maxlength="3" name="ReplicationDelay-value2" id="ReplicationDelay-value2" />
									<p class="warn-text" data-for="ReplicationDelay-value2"></p>									
								</td>
							</tr>
							<tr></tr>							
						</tbody>
					</table>
				</fieldset>
				<div class="btn-wrap">
					<div class="btn-left">
						<button class="Button btn" id="btnRuleCancel">목록으로</button>
					</div>
					<div class="btn-right">
						<button class="Button btn bg-red" id="btnRuleSave">확인</button>
					</div>
				</div>				
			</form>
		</div>
	</div>
	<script type="text/javascript">
		let gNamespaces = null;
		let gServiceData = {};
		let gRules = [];
		let ruleForm = $('form[name=ruleForm]');
		$a.page(function() {
			this.init = function() {
				let isUpdate = !cloudUtil.isEmpty(gParam.alert);
				
				console.log(gParam.alert);
				
				Validator.addMethod('ifRequire', function(element, value, ob) {
					let b = true;
				    if($('input[name='+ob+']:checked').val() == 'Y'){
				    	b = !cloudUtil.isEmpty(value); 
				    }
				    return b;
				});
				let valElements = {}
				ruleForm.find('input[name$=-useYn]:checked').each(function(index,item){
					let type = item.name.split('-')[0];
					valElements[type+'-value2'] = {
						rule : {required:true,ifRequire:item.name},
						message : {ifRequire:'임계치를 입력하세요.'}
					}
				});
				
				ruleForm.validator({
				    elements :valElements
				}).validate();
				gCommon.getNamespaceCombo($('#namespaces')).done(function(selector){
					gNamespaces = selector.select({id:gSelectedNamespace})
										 .addHandler(function(e) {
											  gCommon.setSelectedNamespace(e.currentTarget.id);
											  gCommon.movePage('/zdb07/zdb0720',{selectedNamespace:gSelectedNamespace});
										  });
				});
			
				ruleForm.find('#btnRuleCancel').on('click',function(){
					location.href='/zdb07/zdb0720'
				});
				ruleForm.find('#btnRuleSave').on('click',function(){
					fn_saveAlertRule();
				});
				ruleForm.find('input[name$=-useYn]').on('change',function(){
					fn_setEnabled();	
				});

				fn_getAlertRule();
				fn_setEnabled();
				
				function fn_getAlertRule(){
					$a.ajax({
						url:'/zdbapi/getAlertRulesInService',
						data:gParam,
						success:function(res){
							let ruleList = res.alertRules;
							$('input[name$=value2]').val('');
							if(ruleList != null){ // length 사용중 이상 현상 발생으로 수정 (2019-07-15)
								for(let i = 0;i < ruleList.length;i++){
									let o = ruleList[i];
									let type = o.type.split('-')[2];
									$('input[name='+type+'-useYn][value=Y]').setSelected('Y');
									$('input[name='+type+'-priority][value='+o.priority+']').setSelected(o.priority);
									$('select[name='+type+'-condition]').val(o.condition);
									$('input[name='+type+'-value2]').val(o.value2);
								}
							}
						}
					})
				}
				function fn_saveAlertRule(){
					if(ruleForm.find('p[data-for]:visible.invalid').length > 0){
						return;
					};

					let data = $.extend({},gParam);
					let alertRules = [];
		    		
		    		ruleForm.find('input[name$=-useYn][value=Y]:checked').each(function (index, item) {
		    			let type = item.name.replace('-useYn','');
		    			let priority = $('input[name='+type+'-priority]:checked').val();
		    			let condition = $('select[name='+type+'-priority]').val();
		    			let value2 = $('input[name='+type+'-value2]').val();
		    			let d = {
		    				type : type,
		    				namespace : data.namespace,
		    				serviceName : data.serviceName,
		    				serviceType : data.serviceType,
		    				priority : priority,
		    				condition : condition,
		    				value2 : value2
		    			}
		    			alertRules.push(d);
		    		});
		    		data.alertRules = JSON.stringify(alertRules);
		    		
					gCommon.confirm('저장 하시겠습니까?',function(){
						$a.ajax({
			    			url : '/zdbapi/updateAlertRule',
			    			method : 'put',
			    			data : data,
		    				success:function(res){
		    					if(res.result.code == '0000'){
		    						gCommon.alert('저장되었습니다.');
		    						fn_getAlertRule();
		    					}
		    				}
			    		});				
					});
				}

				function fn_setEnabled(){
					ruleForm.find('input[name$=-useYn]:checked').each(function (index, item) {
						let type = item.name.replace('-useYn','');
						let useYn = item.value == 'Y';
						
						$('input[name='+type+'-priority]').setEnabled(useYn);
		    			$('input[name='+type+'-value2]').setEnabled(useYn);
		    			if(useYn){
			    			$('p.warn-text[data-for='+type+'-value2]').removeClass('hide');
		    			}else{
			    			$('p.warn-text[data-for='+type+'-value2]').addClass('hide');
		    			}
					});
				}
			}
		});
	</script>
</th:block>
</html>